services:
  # 1. AI & Search Stack
  # ----------------------------------------
  ollama:
    image: ollama/ollama:latest
    container_name: alsakr-ollama
    restart: unless-stopped
    volumes:
      - ../ollama_data:/root/.ollama
    networks:
      - industry-net

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: alsakr-es
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - bootstrap.memory_lock=true
    volumes:
      - ../es_data:/usr/share/elasticsearch/data
    ulimits:
      memlock:
        soft: -1
        hard: -1
    networks:
      - industry-net

  qdrant:
    image: qdrant/qdrant:latest
    container_name: alsakr-qdrant
    restart: unless-stopped
    volumes:
      - ../qdrant_data:/qdrant/storage
    networks:
      - industry-net

  # 2. ERPNext / Frappe Stack (Database & Application)
  # ----------------------------------------
  mariadb:
    image: mariadb:10.6
    container_name: alsakr-mariadb
    restart: unless-stopped
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --skip-innodb-read-only-compressed # specific for maria 10.6+
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-admin}
      MYSQL_DATABASE: _auth # Placeholder
    volumes:
      - ../mariadb_data:/var/lib/mysql
    networks:
      - industry-net

  redis-queue:
    image: redis:6.2-alpine
    container_name: alsakr-redis-queue
    restart: unless-stopped
    networks:
      - industry-net

  redis-cache:
    image: redis:6.2-alpine
    container_name: alsakr-redis-cache
    restart: unless-stopped
    networks:
      - industry-net

  redis-socketio:
    image: redis:6.2-alpine
    container_name: alsakr-redis-socketio
    restart: unless-stopped
    networks:
      - industry-net

  erpnext-backend:
    image: frappe/erpnext:version-15
    container_name: alsakr-erpnext-backend
    restart: unless-stopped
    deploy:
      restart_policy:
        condition: on-failure
    environment:
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_PASSWORD=${DB_PASSWORD:-admin}
      - REDIS_CACHE=redis-cache:6379
      - REDIS_QUEUE=redis-queue:6379
      - REDIS_SOCKETIO=redis-socketio:6379
      - SOCKETIO_PORT=9000
    volumes:
      - ../frappe_sites:/home/frappe/frappe-bench/sites
      - ../frappe_logs:/home/frappe/frappe-bench/logs
    networks:
      - industry-net
    depends_on:
      - mariadb
      - redis-queue
      - redis-cache
      - redis-socketio

  erpnext-frontend:
    image: frappe/erpnext-nginx:version-15
    container_name: alsakr-erpnext-frontend
    restart: unless-stopped
    environment:
      - BACKEND=erpnext-backend:8000
      - SOCKETIO=erpnext-backend:9000
      - FRAPPE_SITE_NAME_HEADER=Host
      - SKIP_NGINX_TEMPLATE_GENERATION=0
      - UPSTREAM_REAL_IP_ADDRESS=0.0.0.0/0
      - UPSTREAM_REAL_IP_HEADER=X-Forwarded-For
      - UPSTREAM_REAL_IP_RECURSIVE=on
      - PROXY_READ_TIMEOUT=120
      - CLIENT_MAX_BODY_SIZE=50m
    volumes:
      - ../frappe_sites:/home/frappe/frappe-bench/sites
      - ../frappe_logs:/home/frappe/frappe-bench/logs
    networks:
      - industry-net
    depends_on:
      - erpnext-backend

  erpnext-worker-default:
    image: frappe/erpnext:version-15
    container_name: alsakr-erpnext-worker-d
    restart: unless-stopped
    command: worker-default
    environment:
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_PASSWORD=${DB_PASSWORD:-admin}
      - REDIS_CACHE=redis-cache:6379
      - REDIS_QUEUE=redis-queue:6379
      - REDIS_SOCKETIO=redis-socketio:6379
    volumes:
      - ../frappe_sites:/home/frappe/frappe-bench/sites
      - ../frappe_logs:/home/frappe/frappe-bench/logs
    networks:
      - industry-net
    depends_on:
      - erpnext-backend

  erpnext-schedule:
    image: frappe/erpnext:version-15
    container_name: alsakr-erpnext-schedule
    restart: unless-stopped
    command: schedule
    environment:
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_PASSWORD=${DB_PASSWORD:-admin}
      - REDIS_CACHE=redis-cache:6379
      - REDIS_QUEUE=redis-queue:6379
      - REDIS_SOCKETIO=redis-socketio:6379
    volumes:
      - ../frappe_sites:/home/frappe/frappe-bench/sites
      - ../frappe_logs:/home/frappe/frappe-bench/logs
    networks:
      - industry-net
    depends_on:
      - erpnext-backend

  # 3. Custom App Stack
  # ----------------------------------------
  frontend:
    build:
      context: ../v2_project/frontend
      dockerfile: Dockerfile
    container_name: alsakr-frontend
    restart: always
    environment:
      - NEXT_PUBLIC_API_URL=https://api.app.alsakronline.com
      - NEXT_PUBLIC_ERP_URL=https://erp.app.alsakronline.com
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-changeme}
      - NEXTAUTH_URL=https://app.alsakronline.com
    ports:
      - "3000:3000"
    networks:
      - industry-net
    depends_on:
      - backend

  backend:
    build:
      context: ../v2_project/backend
      dockerfile: Dockerfile
    container_name: alsakr-backend
    restart: always
    environment:
      - OLLAMA_HOST=http://ollama:11434
      - ES_HOST=elasticsearch
      - QDRANT_HOST=qdrant
      - ERPNEXT_URL=http://erpnext-backend:8000
    volumes:
      - ../v2_project/backend:/app
      - ../Data:/data
    ports:
      - "8000:8000"
    networks:
      - industry-net
    depends_on:
      - ollama
      - elasticsearch
      - qdrant

  n8n:
    image: n8nio/n8n:latest
    container_name: alsakr-n8n
    restart: unless-stopped
    environment:
      - N8N_HOST=workflows.app.alsakronline.com
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://workflows.app.alsakronline.com/
    volumes:
      - ../n8n_data:/home/node/.n8n
    ports:
      - "5678:5678"
    networks:
      - industry-net

  # 4. Proxy
  # ----------------------------------------
  caddy:
    image: caddy:latest
    container_name: alsakr-proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ../caddy_data:/data
      - ../caddy_config:/config
    networks:
      - industry-net

networks:
  industry-net:
    driver: bridge
